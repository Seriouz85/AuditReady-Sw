<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Demo Data Debug Test</title>
</head>
<body>
  <h1>Demo Data Debug Test</h1>
  
  <button onclick="clearEnhancementFlag()">1. Clear Enhancement Flag</button>
  <button onclick="checkRequirements()">2. Check Current Requirements Status</button>
  <button onclick="manuallyApplyEnhancement()">3. Manually Apply Enhancement</button>
  
  <div id="output" style="margin-top: 20px; white-space: pre-wrap; font-family: monospace; background: #f5f5f5; padding: 10px; max-height: 400px; overflow-y: auto;"></div>

  <script type="module">
    import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';
    
    const supabaseUrl = 'https://niqtlyirrjjsowlihfey.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5pcXRseWlycmpqc293bGloZmV5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzM2Nzc5MDQsImV4cCI6MjA0OTI1MzkwNH0.ux_tWYFCOepfvHAE9ZQh5pNrqMfaeBgFq8vZcjwbD0E';
    const supabase = createClient(supabaseUrl, supabaseKey);
    
    const DEMO_ORG_ID = '34adc4bb-d1e7-43bd-8249-89c76520533d';
    
    function log(message) {
      const output = document.getElementById('output');
      output.textContent += new Date().toLocaleTimeString() + ' - ' + message + '\n';
      output.scrollTop = output.scrollHeight;
      console.log(message);
    }
    
    window.clearEnhancementFlag = function() {
      try {
        const enhancementKey = `demo_data_enhanced_${DEMO_ORG_ID}`;
        localStorage.removeItem(enhancementKey);
        localStorage.removeItem(`${enhancementKey}_time`);
        log('✅ Enhancement flag cleared');
      } catch (error) {
        log('❌ Error clearing flag: ' + error.message);
      }
    };
    
    window.checkRequirements = async function() {
      try {
        log('🔍 Checking current requirements status...');
        
        const { data: orgReqs, error } = await supabase
          .from('organization_requirements')
          .select('id, status, requirement_id')
          .eq('organization_id', DEMO_ORG_ID);
          
        if (error) throw error;
        
        log(`Found ${orgReqs.length} organization requirements`);
        
        const statusCounts = {};
        orgReqs.forEach(req => {
          statusCounts[req.status] = (statusCounts[req.status] || 0) + 1;
        });
        
        log('Status distribution:');
        Object.entries(statusCounts).forEach(([status, count]) => {
          const percentage = ((count / orgReqs.length) * 100).toFixed(1);
          log(`  ${status}: ${count} (${percentage}%)`);
        });
        
      } catch (error) {
        log('❌ Error checking requirements: ' + error.message);
      }
    };
    
    window.manuallyApplyEnhancement = async function() {
      try {
        log('🎯 Starting manual enhancement...');
        
        // Get all applicable requirements (not not-applicable)
        const { data: allReqs, error: fetchError } = await supabase
          .from('organization_requirements')
          .select('id, requirement_id, status')
          .eq('organization_id', DEMO_ORG_ID)
          .neq('status', 'not-applicable');

        if (fetchError) throw fetchError;
        log(`Found ${allReqs.length} applicable requirements for enhancement`);

        // Calculate distribution: 67% fulfilled
        const totalApplicable = allReqs.length;
        const fulfilledCount = Math.floor(totalApplicable * 0.67);
        const remainingCount = totalApplicable - fulfilledCount;
        const partiallyFulfilledCount = Math.floor(remainingCount * 0.5);
        const notStartedCount = remainingCount - partiallyFulfilledCount;

        log(`Target distribution: ${fulfilledCount} fulfilled, ${partiallyFulfilledCount} partially-fulfilled, ${notStartedCount} not-fulfilled`);

        // Shuffle requirements randomly
        const shuffled = [...allReqs].sort(() => Math.random() - 0.5);

        // Prepare updates
        const updates = [];

        // Set fulfilled requirements
        for (let i = 0; i < fulfilledCount; i++) {
          updates.push({
            id: shuffled[i].id,
            status: 'fulfilled',
            fulfillment_percentage: 100,
            notes: 'Fully implemented - demo data',
            updated_at: new Date().toISOString()
          });
        }

        // Set partially-fulfilled requirements  
        for (let i = fulfilledCount; i < fulfilledCount + partiallyFulfilledCount; i++) {
          updates.push({
            id: shuffled[i].id,
            status: 'partially-fulfilled',
            fulfillment_percentage: Math.floor(Math.random() * 60) + 20,
            notes: 'Implementation in progress - demo data',
            updated_at: new Date().toISOString()
          });
        }

        // Set not-fulfilled requirements
        for (let i = fulfilledCount + partiallyFulfilledCount; i < totalApplicable; i++) {
          updates.push({
            id: shuffled[i].id,
            status: 'not-fulfilled',
            fulfillment_percentage: 0,
            notes: 'Pending implementation - demo data',
            updated_at: new Date().toISOString()
          });
        }

        // Apply updates in batches
        const batchSize = 50;
        for (let i = 0; i < updates.length; i += batchSize) {
          const batch = updates.slice(i, i + batchSize);
          const { error: updateError } = await supabase
            .from('organization_requirements')
            .upsert(batch);

          if (updateError) throw updateError;
          log(`✅ Updated batch ${Math.floor(i/batchSize) + 1} (${batch.length} requirements)`);
        }

        log(`🎉 Enhancement completed! Updated ${updates.length} requirements`);
        
        // Set enhancement flag
        const enhancementKey = `demo_data_enhanced_${DEMO_ORG_ID}`;
        localStorage.setItem(enhancementKey, 'true');
        localStorage.setItem(`${enhancementKey}_time`, Date.now().toString());
        log('✅ Set enhancement flag');
        
      } catch (error) {
        log('❌ Error in manual enhancement: ' + error.message);
        console.error('Full error:', error);
      }
    };
  </script>
</body>
</html>