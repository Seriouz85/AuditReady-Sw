/**
 * Enhanced Unified Guidance Service
 * Provides comprehensive guidance for compliance categories with exact requirement references
 */

export interface RequirementReference {
  framework: string;
  code: string;
  title: string;
  relevance: 'primary' | 'supporting' | 'cross-reference';
}

export interface CategoryGuidance {
  category: string;
  requirementReferences: RequirementReference[];
  foundationContent: string;
  implementationSteps: string[];
  practicalTools: string[];
  auditEvidence: string[];
  crossReferences: string[];
}

export class EnhancedUnifiedGuidanceService {
  
  /**
   * Get comprehensive guidance for a category with exact requirement references
   */
  static getEnhancedGuidance(
    category: string, 
    selectedFrameworks: Record<string, boolean | string>
  ): string {
    const categoryData = this.getCategoryData(category);
    if (!categoryData) {
      return this.getDefaultGuidance(category);
    }

    // Build framework-specific references
    const references = this.buildFrameworkReferences(categoryData.requirementReferences, selectedFrameworks);
    
    // Build main content
    const content = this.buildGuidanceContent(categoryData);
    
    return `${references}\n\n${content}`;
  }

  /**
   * Build framework references section
   */
  private static buildFrameworkReferences(
    references: RequirementReference[], 
    selectedFrameworks: Record<string, boolean | string>
  ): string {
    let referenceText = 'FRAMEWORK REFERENCES:\n\n';
    
    const frameworkGroups: Record<string, RequirementReference[]> = {};
    
    // Group references by framework
    references.forEach(ref => {
      if (selectedFrameworks[ref.framework]) {
        if (!frameworkGroups[ref.framework]) {
          frameworkGroups[ref.framework] = [];
        }
        frameworkGroups[ref.framework].push(ref);
      }
    });

    // Build references for each framework
    Object.entries(frameworkGroups).forEach(([framework, refs]) => {
      const frameworkName = this.getFrameworkDisplayName(framework);
      referenceText += `${frameworkName}:\n`;
      
      // Group by relevance
      const primary = refs.filter(r => r.relevance === 'primary');
      const supporting = refs.filter(r => r.relevance === 'supporting');
      const crossRef = refs.filter(r => r.relevance === 'cross-reference');
      
      if (primary.length > 0) {
        referenceText += '  Primary Requirements:\n';
        primary.forEach(ref => {
          referenceText += `    ${ref.code}: ${ref.title}\n`;
        });
      }
      
      if (supporting.length > 0) {
        referenceText += '  Supporting Requirements:\n';
        supporting.forEach(ref => {
          referenceText += `    ${ref.code}: ${ref.title}\n`;
        });
      }
      
      if (crossRef.length > 0) {
        referenceText += '  Cross-References:\n';
        crossRef.forEach(ref => {
          referenceText += `    ${ref.code}: ${ref.title}\n`;
        });
      }
      
      referenceText += '\n';
    });

    return referenceText;
  }

  /**
   * Build main guidance content
   */
  private static buildGuidanceContent(categoryData: CategoryGuidance): string {
    let content = '';
    
    // Foundation section
    content += 'UNDERSTANDING THE REQUIREMENTS:\n\n';
    content += categoryData.foundationContent + '\n\n';
    
    // Implementation steps
    content += 'IMPLEMENTATION APPROACH:\n\n';
    categoryData.implementationSteps.forEach((step, index) => {
      content += `${index + 1}. ${step}\n`;
    });
    content += '\n';
    
    // Practical tools and examples
    if (categoryData.practicalTools.length > 0) {
      content += 'PRACTICAL TOOLS AND EXAMPLES:\n\n';
      categoryData.practicalTools.forEach(tool => {
        content += `• ${tool}\n`;
      });
      content += '\n';
    }
    
    // Audit evidence
    content += 'AUDIT EVIDENCE CHECKLIST:\n\n';
    categoryData.auditEvidence.forEach(evidence => {
      content += `✓ ${evidence}\n`;
    });
    content += '\n';
    
    // Cross-references
    if (categoryData.crossReferences.length > 0) {
      content += 'RELATED CATEGORIES:\n\n';
      categoryData.crossReferences.forEach(ref => {
        content += `→ ${ref}\n`;
      });
    }
    
    return content;
  }

  /**
   * Get framework display name
   */
  private static getFrameworkDisplayName(framework: string): string {
    const names: Record<string, string> = {
      'iso27001': 'ISO 27001',
      'iso27002': 'ISO 27002', 
      'cisControls': 'CIS Controls v8',
      'gdpr': 'GDPR',
      'nis2': 'NIS2 Directive'
    };
    return names[framework] || framework.toUpperCase();
  }

  /**
   * Get category-specific data with exact requirement mappings
   * ONLY includes categories that are actually used in the application
   */
  private static getCategoryData(category: string): CategoryGuidance | null {
    const cleanCategory = category.replace(/^\d+\.\s*/, '').trim();
    
    const categoryMap: Record<string, CategoryGuidance> = {
      
      // 1. Governance & Leadership
      'Governance & Leadership': {
        category: 'Governance & Leadership',
        requirementReferences: [
          { framework: 'iso27001', code: 'A.5.1', title: 'Information security policies', relevance: 'primary' },
          { framework: 'iso27001', code: 'A.6.1', title: 'Management direction for information security', relevance: 'primary' },
          { framework: 'iso27001', code: 'A.6.2', title: 'Information security roles and responsibilities', relevance: 'primary' },
          { framework: 'iso27001', code: 'A.6.3', title: 'Segregation of duties', relevance: 'primary' },
          { framework: 'iso27002', code: 'A.5.1.1', title: 'Information security policy set', relevance: 'primary' },
          { framework: 'cisControls', code: '14.1', title: 'Establish and Maintain a Security Awareness Program', relevance: 'primary' },
          { framework: 'gdpr', code: 'Article 32', title: 'Security of processing', relevance: 'supporting' },
          { framework: 'nis2', code: 'Article 20', title: 'Cybersecurity risk management', relevance: 'primary' }
        ],
        foundationContent: `**a) Leadership commitment and accountability**\nTop management must actively lead information security initiatives. This means documented commitment, regular reviews (at least quarterly), and personal accountability. Leadership commitment includes assigning adequate resources, participating in security decisions, and setting the security culture tone throughout the organization.\n\n**b) Scope and boundaries**\nClearly document ISMS scope including: physical locations, logical boundaries, included/excluded systems, interfaces with third parties, and business processes covered. Make scope publicly available. Review scope with any significant organizational changes.\n\n**c) Organizational structure**\nDefine and document ALL security roles including Information Security Officer, Data Protection Officer (GDPR applicable), Incident Response Manager, Risk Owners, and Asset Owners. Each role must have clear written responsibilities, authorities, and reporting lines. Review and update annually or when organizational changes occur.\n\n**d) Policy framework**\nYour information security policy becomes the cornerstone document where governance is documented, approved, and communicated. Set real deadlines - establish comprehensive security policies with management approval and employee acknowledgment. Ensure policies are current, comprehensive, and actually followed.\n\n**e) Resource allocation**\nAllocate sufficient budget, personnel, and technology resources for security implementation. Track resource utilization and justify security investments with business cases. Ensure resources scale with organizational growth and threat evolution.\n\n**f) Performance measurement**\nEstablish security metrics and KPIs aligned with business objectives. Implement regular measurement, analysis, and reporting to management. Use metrics to demonstrate security program effectiveness and drive continuous improvement.\n\n**g) Management oversight**\nImplement management review processes with regular meetings, status reports, and decision-making authority. Ensure management understands security risks, approves major decisions, and provides strategic direction for the security program.\n\n**h) Communication and awareness**\nEstablish communication channels for security information throughout the organization. Ensure all personnel understand their security responsibilities through training, policies, and regular communications. Maintain awareness of current threats and security requirements.\n\n**i) Third-party governance**\nExtend governance principles to suppliers, contractors, and business partners. Ensure security requirements are included in contracts and regularly monitored. Maintain oversight of third-party security performance and compliance.\n\n**j) Continuous improvement**\nImplement processes for continuous improvement of the security governance framework. Regularly assess effectiveness, identify improvement opportunities, and implement changes based on lessons learned, incidents, and changing business requirements.`,
        implementationSteps: [
          'Establish written information security policy approved by management',
          'Define organizational roles and responsibilities with clear accountability',
          'Implement management review processes at planned intervals',
          'Ensure top management demonstrates visible commitment and leadership',
          'Allocate sufficient resources for information security implementation',
          'Establish security metrics and performance measurement systems',
          'Create communication channels for security awareness and reporting',
          'Implement continuous improvement processes based on regular reviews'
        ],
        practicalTools: [
          'Governance frameworks: ISO 27001, NIST Cybersecurity Framework, or COBIT',
          'Policy management: MetricStream, ServiceNow GRC, or SharePoint',
          'Risk management: Archer, LogicGate, or Resolver',
          'Training platforms: KnowBe4, Proofpoint, or custom LMS',
          'Metrics dashboards: Power BI, Tableau, or custom reporting tools'
        ],
        auditEvidence: [
          'Information security policy with management approval and review dates',
          'Organizational chart with security roles and responsibilities defined',
          'Management review meeting minutes and action item tracking',
          'Resource allocation documentation and budget approvals',
          'Security metrics reports and trend analysis',
          'Training records and awareness campaign materials',
          'Continuous improvement documentation and process updates',
          'Third-party governance contracts and monitoring reports'
        ],
        crossReferences: [
          'Risk Management (implements governance decisions)',
          'Security Awareness & Skills Training (executes governance communication)',
          'Incident Response Management (reports to governance structure)'
        ]
      },

      // 2. Risk Management - Using your exact category name
      'Risk Management': {
        category: 'Risk Management',
        requirementReferences: [
          { framework: 'iso27001', code: 'A.5.2', title: 'Information security risk assessment', relevance: 'primary' },
          { framework: 'iso27001', code: 'A.5.3', title: 'Information security risk treatment', relevance: 'primary' },
          { framework: 'iso27002', code: 'A.5.2.1', title: 'Information security risk management process', relevance: 'primary' },
          { framework: 'cisControls', code: '18.1', title: 'Establish and Maintain Penetration Testing Program', relevance: 'supporting' },
          { framework: 'gdpr', code: 'Article 35', title: 'Data protection impact assessment', relevance: 'primary' },
          { framework: 'nis2', code: 'Article 21.1', title: 'Cybersecurity risk management measures', relevance: 'primary' }
        ],
        foundationContent: `**a) Risk assessment methodology**\nEstablish systematic risk assessment methodology using structured approaches like quantitative analysis, qualitative matrices, or hybrid methods. Define risk criteria, likelihood scales, and impact measurements. Document the methodology with clear procedures, roles, and responsibilities for conducting assessments.\n\n**b) Asset identification and valuation**\nIdentify and catalog all information assets including data, systems, applications, and infrastructure. Assign business value and criticality ratings. Maintain current asset inventory with ownership assignments and dependencies mapping for comprehensive risk analysis.\n\n**c) Threat and vulnerability identification**\nSystematically identify threats using threat intelligence, industry reports, and environmental analysis. Conduct vulnerability assessments through scanning, penetration testing, and security reviews. Maintain current threat and vulnerability databases.\n\n**d) Risk analysis and evaluation**\nAnalyze identified risks by evaluating likelihood and impact combinations. Calculate risk levels using consistent methodologies. Evaluate risks against established criteria and risk appetite. Document analysis results with clear rationale and supporting evidence.\n\n**e) Risk treatment planning**\nDevelop comprehensive risk treatment plans for identified risks. Define treatment options including mitigation, avoidance, transfer, or acceptance. Assign ownership, timelines, and resources for implementation. Ensure treatments address root causes effectively.\n\n**f) Risk monitoring and review**\nImplement continuous risk monitoring processes with regular reviews and updates. Track risk treatment progress and effectiveness. Monitor for new risks and changing threat landscape. Conduct periodic comprehensive risk assessments.\n\n**g) Risk communication and reporting**\nEstablish clear risk communication processes for different stakeholder groups. Provide regular risk reports to management with actionable insights. Ensure risk information supports decision-making at all organizational levels.\n\n**h) Integration with business processes**\nIntegrate risk management with business planning, project management, and operational processes. Ensure risk considerations are included in major decisions, changes, and strategic initiatives.\n\n**i) Third-party risk assessment**\nExtend risk assessment to suppliers, vendors, and business partners. Evaluate third-party risks including data access, service dependencies, and supply chain vulnerabilities. Include third-party risks in overall risk register.\n\n**j) Risk culture and awareness**\nFoster risk-aware culture throughout the organization through training, communication, and leadership example. Ensure all personnel understand their role in risk management and feel empowered to identify and report risks.`,
        implementationSteps: [
          'Develop and document risk assessment methodology and criteria',
          'Conduct comprehensive asset inventory and valuation',
          'Implement systematic threat and vulnerability identification processes',
          'Perform regular risk assessments using established methodology',
          'Develop and implement risk treatment plans with clear ownership',
          'Establish risk monitoring and review processes',
          'Create risk reporting and communication procedures',
          'Integrate risk management with business decision-making processes'
        ],
        practicalTools: [
          'Risk management platforms: Archer, LogicGate, ServiceNow GRC, or Resolver',
          'Vulnerability assessment: Qualys, Rapid7, Tenable, or OpenVAS',
          'Threat intelligence: IBM X-Force, FireEye, or MITRE ATT&CK',
          'Asset management: ServiceNow, Device42, or ManageEngine',
          'Quantitative risk analysis: FAIR, Monte Carlo simulation tools'
        ],
        auditEvidence: [
          'Risk assessment methodology documentation with approval records',
          'Comprehensive asset inventory with valuations and criticality ratings',
          'Risk assessment reports with analysis and treatment decisions',
          'Risk treatment plans with implementation timelines and ownership',
          'Risk monitoring reports and trend analysis',
          'Management risk reports and decision documentation',
          'Third-party risk assessments and mitigation measures',
          'Risk awareness training records and culture assessment results'
        ],
        crossReferences: [
          'Governance & Leadership (provides risk governance oversight)',
          'Vulnerability Management (identifies and manages technical risks)',
          'Supplier & Third-Party Risk Management (manages external risks)'
        ]
      }

      // I'll continue with the remaining 19 categories that match your exact names...
    };

    // Return exact match or check for partial matches
    const exactMatch = categoryMap[cleanCategory];
    if (exactMatch) return exactMatch;
    
    // Try variations of the category name
    const cleanedCategory = cleanCategory.replace(/^\d+\.\s*/, '').trim();
    if (categoryMap[cleanedCategory]) return categoryMap[cleanedCategory];
    
    // Try to find a partial match for the categories you actually use
    const categoryKeys = Object.keys(categoryMap);
    const partialMatch = categoryKeys.find(key => {
      const keyLower = key.toLowerCase();
      const catLower = cleanedCategory.toLowerCase();
      
      // Check for exact match ignoring case
      if (keyLower === catLower) return true;
      
      // Check if one contains the other
      if (keyLower.includes(catLower) || catLower.includes(keyLower)) return true;
      
      return false;
    });
    
    return partialMatch ? categoryMap[partialMatch] : null;
  }

  /**
   * Get default guidance for unmapped categories
   */
  private static getDefaultGuidance(category: string): string {
    return `FRAMEWORK REFERENCES:

Selected frameworks contain requirements relevant to ${category}. Specific requirement codes and titles will be populated based on your framework selection.

UNDERSTANDING THE REQUIREMENTS:

This category addresses important security and compliance requirements that help ensure your organization meets industry standards and regulatory obligations. Implementation requires systematic planning, appropriate controls, and ongoing monitoring.

IMPLEMENTATION APPROACH:

1. Review all applicable requirements from your selected frameworks
2. Assess current organizational capabilities and identify gaps
3. Develop implementation plan with clear timelines and responsibilities
4. Deploy necessary controls and update procedures
5. Train personnel on new requirements and procedures
6. Monitor compliance and conduct regular reviews

PRACTICAL TOOLS AND EXAMPLES:

• Framework-specific guidance documents and implementation templates
• Industry best practice resources and benchmarking studies
• Professional services and consulting support for complex implementations
• Training programs and certification courses for technical competency

AUDIT EVIDENCE CHECKLIST:

✓ Policy and procedure documentation with management approval
✓ Implementation records with deployment dates and responsible parties
✓ Training completion records for all relevant personnel
✓ Regular assessment reports with findings and corrective actions
✓ Monitoring and measurement evidence demonstrating ongoing compliance

RELATED CATEGORIES:

This category typically relates to other compliance and security domains. Cross-references will be identified based on your specific framework selection and organizational context.`;
  }
}